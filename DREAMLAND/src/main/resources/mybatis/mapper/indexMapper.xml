<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.dreamland.prj.mapper.IndexMapper">
	
	<!-- 부서 + 직원 전체 리스트 조회 -->
  <select id="getUser" resultType="EmployeeDto">
    SELECT E.EMP_NO, E.EMP_NAME, E.BIRTH, E.EMAIL, E.MOBILE, E.ROLE, E.PROFILE_PATH, D.DEPT_NO, D.DEPT_NAME, P.POS_NO, P.POS_NAME
      FROM EMPLOYEE E
      JOIN DEPARTMENT D ON E.DEPT_NO = D.DEPT_NO
      JOIN POSITION P ON E.POS_NO = P.POS_NO
     WHERE EMAIL = #{email}
  </select>


  <!-- 근태관리 -->
  <insert id="insertWork" parameterType="WorkDto">
    INSERT INTO WORK (
        WORK_NO
      , WORK_DATE
      , WORK_IN
      , WORK_OUT
      , WORK_TOTAL_TIME
      , WORK_STATE
      , LATE_YN
      , EMP_NO
    ) VALUES (
        WORK_SEQ.NEXTVAL
      , TO_DATE(TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD')
      , TO_TIMESTAMP(TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD HH24:MI:SS')
      , NULL
      , NULL
      , 10
      , 'N'
      , #{empNo}      
    )
  </insert>
  
  <select id="hasCheckedWorkIn" parameterType="int" resultType="int">
    SELECT COUNT(*)
      FROM WORK
     WHERE EMP_NO = #{empNo}
       AND WORK_DATE = TO_DATE(TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD')
  </select>
  
  <update id="updateWorkOut" parameterType="WorkDto">
    UPDATE WORK
       SET WORK_OUT = TO_TIMESTAMP(TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD HH24:MI:SS')
         , WORK_TOTAL_TIME = ROUND((TO_NUMBER(TO_CHAR(CURRENT_TIMESTAMP, 'SSSSS')) - TO_NUMBER(TO_CHAR(WORK_IN, 'SSSSS'))) / 3600, 2)
     WHERE EMP_NO = #{empNo}     
  </update>
  
  <update id="updateCheckedWorkOut">
    UPDATE WORK
       SET WORK_OUT = TO_TIMESTAMP(TO_CHAR(SYSDATE, 'YYYY-MM-DD') || ' 18:00:00', 'YYYY-MM-DD HH24:MI:SS')
         , WORK_TOTAL_TIME = ROUND((TO_NUMBER(TO_CHAR(TO_TIMESTAMP(TO_CHAR(SYSDATE, 'YYYY-MM-DD') || ' 18:00:00', 'YYYY-MM-DD HH24:MI:SS'), 'SSSSS')) - TO_NUMBER(TO_CHAR(WORK_IN, 'SSSSS'))) / 3600, 2)
     WHERE WORK_OUT IS NULL
  </update>
  
  
  <!-- 공지사항 리스트 -->
  <select id="getNoticeList" parameterType="NoticeBoardDto">
    SELECT ROW_NUMBER() OVER(ORDER BY 
      CASE WHEN SIGNAL = 1 THEN 0 ELSE 1 END, NOTICE_NO DESC)
         , NOTICE_NO, BOARD_TITLE, SIGNAL, BOARD_MODIFY_DT
      FROM NOTICE_BOARD
  </select>
  
  
  <!-- 쪽지 건수 확인 -->
  <select id="getMessageCountByReceiver">
    SELECT COUNT(*)
      FROM MESSAGE M JOIN EMPLOYEE ES ON M.MSG_SENDER = ES.EMP_NO JOIN EMPLOYEE ER ON M.MSG_RECEIVER = ER.EMP_NO
     WHERE M.MSG_RECEIVER = ${empNo} AND READ_YN = 'N'
  </select>
  
  <!-- 결재 대기문서 -->
  <select id="getWaitCount">
	  SELECT COUNT(*)
	    FROM APPROVAL B
	   WHERE B.APV_NO IN (SELECT APV_NO
	                        FROM (SELECT APV_NO, WRITER_LIST, APV_STATE, EMP_NO,
	                                     ROW_NUMBER() OVER (PARTITION BY APV_NO, APV_STATE ORDER BY WRITER_LIST) as RN
	                                FROM APV_WRITER
	                               WHERE APV_STATE = 100)
	                       WHERE RN = 1 
	                         AND EMP_NO = #{empNo})
	     AND NOT B.APV_CHECK = 3
  </select>

	<!-- 결재 진행문서 -->
	<select id="getMyApvCount">
	  SELECT COUNT(*)
	    FROM APPROVAL
	   WHERE EMP_NO = #{empNo}
	     AND APV_CHECK = 0
	</select>

</mapper> 