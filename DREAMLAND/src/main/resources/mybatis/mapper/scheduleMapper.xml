<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="com.dreamland.prj.mapper.ScheduleMapper">
   
	  <resultMap id="SkdMap" type="ScheduleDto">
	      <id property="skdNo" column="SKD_NO"/>
	      <result property="skdStart" column="SKD_START"/>
	      <result property="skdEnd" column="SKD_END"/>
	      <result property="skdCategory" column="SKD_CATEGORY"/>
	      <result property="skdTitle" column="SKD_TITLE"/>
	      <result property="skdContents" column="SKD_CONTENTS"/>
	      <result property="skdColor" column="SKD_COLOR"/>
	      <association property="employee" javaType="EmployeeDto">
		        <id property="empNo" column="EMP_NO"/>
		        <result property="empName" column="EMP_NAME"/>
		        <result property="deptNo" column="DEPT_NO"/>
        </association>
        <collection property="shrDept" ofType="SkdShrDeptDto">
            <result property="skdNo" column="SKD_NO"/>
            <result property="deptNo" column="DEPT_NO"/>
        </collection>
	  </resultMap> 
	  
	  
  <!-- INSERT 수행 이전에 파라미터 ScheduleDto의 skdNo 필드에 SKD_SEQ.NEXTVAL 값을 저장 --> 
	  <insert id="skdAdd"
	          parameterType="ScheduleDto">
	   <selectKey order="BEFORE" keyProperty="skdNo" resultType="int">
	      SELECT SKD_SEQ.NEXTVAL
	        FROM DUAL
	   </selectKey>       
	      INSERT INTO SCHEDULE (
	          SKD_NO
	        , SKD_START
	        , SKD_END
	        , SKD_CATEGORY
	        , SKD_TITLE
	        , SKD_CONTENTS
	        , SKD_COLOR
	        , EMP_NO  
	      ) VALUES (
	          #{skdNo}
	        , #{skdStart}
	        , #{skdEnd}
	        , #{skdCategory}
	        , #{skdTitle}
	        , #{skdContents}
	        , #{skdColor}
	        , #{employee.empNo}
	      )
	  </insert>
	  
	  <insert id="addShrDept" 
	          parameterType="SkdShrDeptDto">
	     INSERT INTO SKD_SHR_DEPT (
	         SKD_NO
	       , DEPT_NO
	     ) VALUES (
	         #{skdNo}
	       , #{deptNo}
	     )
    </insert>
	  
	  <select id="getSkdList"
	          parameterType="Map"
	          resultMap="SkdMap">
	     SELECT S.SKD_NO, S.SKD_START, S.SKD_END, S.SKD_CATEGORY, S.SKD_TITLE, S.SKD_CONTENTS, S.SKD_COLOR
	          , E.EMP_NO, E.EMP_NAME, E.DEPT_NO
	          , SSD.DEPT_NO AS SHARED_DEPT_NO
         FROM SCHEDULE S
        INNER JOIN EMPLOYEE E ON S.EMP_NO = E.EMP_NO
        LEFT JOIN SKD_SHR_DEPT SSD ON S.SKD_NO = SSD.SKD_NO
        WHERE S.EMP_NO = #{empNo} OR SSD.DEPT_NO = #{deptNo} 
        
      <!--  세션 오류 발생용  --> 
   <!--    SELECT S.SKD_NO, S.SKD_START, S.SKD_END, S.SKD_CATEGORY, S.SKD_TITLE, S.SKD_CONTENTS, S.SKD_COLOR, E.EMP_NO,
           E.EMP_NAME, E.DEPT_NO,
           SSD.DEPT_NO AS SHARED_DEPT_NO
    FROM SCHEDULE S
    INNER JOIN EMPLOYEE E ON S.EMP_NO = E.EMP_NO
    LEFT JOIN SKD_SHR_DEPT SSD ON S.SKD_NO = SSD.SKD_NO  -->
    
	  </select>
    
    <select id="getSkdByNo"
            resultMap="SkdMap">
       SELECT S.SKD_NO, S.SKD_START, S.SKD_END, S.SKD_CATEGORY, S.SKD_TITLE, S.SKD_CONTENTS, S.SKD_COLOR
			      , E.EMP_NO, E.EMP_NAME, E.DEPT_NO
			    FROM SCHEDULE S
			    INNER JOIN EMPLOYEE E ON S.EMP_NO = E.EMP_NO
			    LEFT JOIN SKD_SHR_DEPT SSD ON S.SKD_NO = SSD.SKD_NO
			    WHERE S.SKD_NO = #{skdNo}
    </select>
    
    <select id="getShrDeptNo"
            resultType="SkdShrDeptDto">
       SELECT DEPT_NO
         FROM SKD_SHR_DEPT
        WHERE SKD_NO = #{skdNo}
    </select>
    
    <update id="updateSkd"
            parameterType="ScheduleDto">
      UPDATE SCHEDULE
			   SET SKD_START = #{skdStart},
			       SKD_END = #{skdEnd},
			       SKD_CATEGORY = #{skdCategory},
			       SKD_TITLE = #{skdTitle},
			       SKD_CONTENTS = #{skdContents},
			       SKD_COLOR = #{skdColor}
			 WHERE SKD_NO = #{skdNo}
    </update>
    
    <delete id="deleteSkd">
      DELETE
        FROM SCHEDULE
       WHERE SKD_NO = #{skdNo}
    </delete>
    
    <delete id="deleteShrDept">
        DELETE 
          FROM SKD_SHR_DEPT 
         WHERE SKD_NO = #{skdNo}
    </delete>
    
    
 </mapper>